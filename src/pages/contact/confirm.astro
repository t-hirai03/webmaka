---
import SectionTitle from '@/components/ui/SectionTitle.astro';
import Layout from '@/layouts/Layout.astro';

const INQUIRY_TYPE_LABELS: Record<string, string> = {
	website: 'Webサイト制作',
	lp: 'LP制作',
	cms: 'CMS導入・移行',
	coding: 'コーディング代行',
	other: 'その他',
};
---

<Layout title="入力内容の確認 | うぇぶまか" noindex>
  <section class="pt-12 pb-16 md:pt-80px md:pb-20 bg-bg-section min-h-page">
    <div class="max-w-container mx-auto px-4 flex flex-col items-center gap-8">
      <SectionTitle title="Contact" subtitle="お問い合わせ" />
      <div id="confirm-content" class="max-w-form w-full flex flex-col items-center gap-8">
        <p class="text-center text-text-muted">読み込み中...</p>
      </div>
    </div>
  </section>
</Layout>

<script is:inline define:vars={{ INQUIRY_TYPE_LABELS }}>
  const STORAGE_KEY = 'contactFormData';

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function init() {
    const contentEl = document.getElementById('confirm-content');
    const storedData = sessionStorage.getItem(STORAGE_KEY);

    if (!storedData) {
      window.location.href = '/contact';
      return;
    }

    const data = JSON.parse(storedData);
    const inquiryLabel = INQUIRY_TYPE_LABELS[data.inquiryType] || '未選択';

    contentEl.innerHTML = `
      <nav aria-label="お問い合わせ進捗" class="w-full max-w-progress">
        <ol class="progressbar">
          <li class="item active"><span class="font-medium">ご入力</span></li>
          <li class="item active"><span class="font-medium">ご確認</span></li>
          <li class="item"><span class="font-medium">完了</span></li>
        </ol>
      </nav>
      <div class="w-full flex flex-col gap-6">
        <div class="form-field space-y-1">
          <p class="block text-sm font-medium text-text">氏名<span class="text-red-500 ml-1">*</span></p>
          <p class="text-text text-base">${escapeHtml(data.name)}</p>
        </div>
        <div class="form-field space-y-1">
          <p class="block text-sm font-medium text-text">メールアドレス<span class="text-red-500 ml-1">*</span></p>
          <p class="text-text text-base">${escapeHtml(data.email)}</p>
        </div>
        <div class="form-field space-y-1">
          <p class="block text-sm font-medium text-text">お問い合わせ種別</p>
          <p class="text-text text-base">${escapeHtml(inquiryLabel)}</p>
        </div>
        <div class="form-field space-y-1">
          <p class="block text-sm font-medium text-text">お電話番号</p>
          <p class="text-text text-base">${escapeHtml(data.phone || '未入力')}</p>
        </div>
        <div class="form-field space-y-1">
          <p class="block text-sm font-medium text-text">お問い合わせ内容<span class="text-red-500 ml-1">*</span></p>
          <p class="text-text text-base whitespace-pre-wrap">${escapeHtml(data.message)}</p>
        </div>
        <div id="confirm-message" class="hidden px-4 py-3 rounded-lg text-center" aria-live="polite"></div>
      </div>
    `;

    // 固定ボタンエリアを作成
    const fixedButtonArea = document.createElement('div');
    fixedButtonArea.id = 'fixed-button-area';
    fixedButtonArea.className = 'fixed bottom-0 left-0 right-0 bg-bg-section px-4 py-4 z-10';
    fixedButtonArea.innerHTML = `
      <div class="max-w-form mx-auto flex flex-row gap-4 justify-center">
        <button type="button" id="back-button" class="flex-1 max-w-200px px-4 py-4 rounded-lg font-semibold text-base cursor-pointer transition-colors bg-gray-200 text-text border-none hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed">修正する</button>
        <button type="button" id="submit-button" class="flex-1 max-w-200px px-4 py-4 rounded-lg font-semibold text-base cursor-pointer transition-colors bg-gold text-white border-none hover:bg-gold-dark disabled:opacity-50 disabled:cursor-not-allowed">送信する</button>
      </div>
    `;
    document.body.appendChild(fixedButtonArea);

    // コンテンツ下部に固定ボタン分の余白を追加
    const section = document.querySelector('section');
    section.style.paddingBottom = '100px';

    document.getElementById('back-button').addEventListener('click', () => {
      window.location.href = '/contact';
    });

    document.getElementById('submit-button').addEventListener('click', async () => {
      const submitButton = document.getElementById('submit-button');
      const backButton = document.getElementById('back-button');
      const messageEl = document.getElementById('confirm-message');

      submitButton.disabled = true;
      submitButton.textContent = '送信中...';
      backButton.disabled = true;
      messageEl.textContent = '';
      messageEl.classList.add('hidden');
      messageEl.classList.remove('bg-red-100', 'text-red-800');

      try {
        const response = await fetch('/api/contact', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: storedData,
        });

        const result = await response.json();

        if (result.success) {
          sessionStorage.removeItem(STORAGE_KEY);
          window.location.href = '/contact/thanks';
        } else {
          messageEl.textContent = result.error || '送信に失敗しました。もう一度お試しください。';
          messageEl.classList.remove('hidden');
          messageEl.classList.add('bg-red-100', 'text-red-800');
          submitButton.disabled = false;
          submitButton.textContent = '送信する';
          backButton.disabled = false;
        }
      } catch {
        messageEl.textContent = '通信エラーが発生しました。もう一度お試しください。';
        messageEl.classList.remove('hidden');
        messageEl.classList.add('bg-red-100', 'text-red-800');
        submitButton.disabled = false;
        submitButton.textContent = '送信する';
        backButton.disabled = false;
      }
    });
  }

  init();
</script>
