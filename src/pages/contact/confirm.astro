---
import Layout from '@/layouts/Layout.astro';

const INQUIRY_TYPE_LABELS: Record<string, string> = {
	website: 'Webサイト制作',
	lp: 'LP制作',
	cms: 'CMS導入・移行',
	coding: 'コーディング代行',
	other: 'その他',
};
---

<Layout title="入力内容の確認 | うぇぶまか" noindex>
  <section class="pt-[calc(48px+var(--height-header-mobile))] pb-16 sm:pt-12 md:pt-80px md:pb-20 bg-bg-section min-h-page">
    <div class="max-w-container mx-auto px-4 flex flex-col items-center">
      <div id="confirm-content" class="max-w-form w-full flex flex-col items-center gap-8">
        <p class="text-center text-text-muted">読み込み中...</p>
      </div>
    </div>
  </section>
</Layout>

<script is:inline define:vars={{ INQUIRY_TYPE_LABELS }}>
  const STORAGE_KEY = 'contactFormData';

  // ストレージユーティリティ（sessionStorage優先、フォールバックでlocalStorage）
  function getFromStorage(key) {
    try {
      const sessionData = sessionStorage.getItem(key);
      if (sessionData) return sessionData;
    } catch {
      // sessionStorageが使えない場合は無視
    }
    try {
      return localStorage.getItem(key);
    } catch {
      return null;
    }
  }

  function removeFromStorage(key) {
    try {
      sessionStorage.removeItem(key);
    } catch {
      // 無視
    }
    try {
      localStorage.removeItem(key);
    } catch {
      // 無視
    }
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // リトライ設定
  const RETRY_CONFIG = {
    maxRetries: 3,
    baseDelay: 1000,
    maxDelay: 10000,
    timeout: 30000,
  };

  // 指数バックオフでの待機時間計算
  function getRetryDelay(attempt) {
    const delay = Math.min(
      RETRY_CONFIG.baseDelay * Math.pow(2, attempt),
      RETRY_CONFIG.maxDelay
    );
    // ジッターを追加（±25%）
    return delay * (0.75 + Math.random() * 0.5);
  }

  // タイムアウト付きfetch
  async function fetchWithTimeout(url, options, timeout) {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), timeout);

    try {
      const response = await fetch(url, {
        ...options,
        signal: controller.signal,
      });
      return response;
    } finally {
      clearTimeout(timeoutId);
    }
  }

  // エラータイプの判定
  function getErrorType(error) {
    if (error.name === 'AbortError') {
      return 'timeout';
    }
    if (!navigator.onLine) {
      return 'offline';
    }
    return 'network';
  }

  // エラーメッセージの取得
  function getErrorMessage(errorType, statusCode, serverMessage) {
    switch (errorType) {
      case 'timeout':
        return '接続がタイムアウトしました。ネットワーク環境を確認して再度お試しください。';
      case 'offline':
        return 'インターネットに接続されていません。接続を確認して再度お試しください。';
      case 'network':
        return '通信エラーが発生しました。しばらく待ってから再度お試しください。';
      case 'server':
        if (statusCode >= 500) {
          return 'サーバーエラーが発生しました。しばらく待ってから再度お試しください。';
        }
        if (statusCode === 429) {
          return '送信回数の上限に達しました。しばらく待ってから再度お試しください。';
        }
        return serverMessage || '送信に失敗しました。入力内容を確認して再度お試しください。';
      default:
        return '予期せぬエラーが発生しました。もう一度お試しください。';
    }
  }

  // リトライ付きAPI送信
  async function submitWithRetry(data, onProgress) {
    let lastStatusCode = null;
    let lastErrorType = null;
    let lastServerMessage = null;

    for (let attempt = 0; attempt <= RETRY_CONFIG.maxRetries; attempt++) {
      if (attempt > 0) {
        const delay = getRetryDelay(attempt - 1);
        onProgress(`再試行中... (${attempt}/${RETRY_CONFIG.maxRetries})`);
        await new Promise(resolve => setTimeout(resolve, delay));
      }

      try {
        const response = await fetchWithTimeout(
          '/api/contact',
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: data,
          },
          RETRY_CONFIG.timeout
        );

        const result = await response.json();

        if (result.success) {
          return { success: true };
        }

        // サーバーからのエラーレスポンス
        lastErrorType = 'server';
        lastStatusCode = response.status;
        lastServerMessage = result.error;

        // クライアントエラー（4xx）はリトライしない（429を除く）
        if (response.status >= 400 && response.status < 500 && response.status !== 429) {
          break;
        }

        // 429もリトライ対象外（レート制限は待っても無駄）
        if (response.status === 429) {
          break;
        }
      } catch (error) {
        lastErrorType = getErrorType(error);
        lastStatusCode = null;
        lastServerMessage = null;

        // オフラインはリトライしない
        if (lastErrorType === 'offline') {
          break;
        }
      }
    }

    return {
      success: false,
      errorType: lastErrorType,
      statusCode: lastStatusCode,
      message: getErrorMessage(lastErrorType, lastStatusCode, lastServerMessage),
    };
  }

  function init() {
    const contentEl = document.getElementById('confirm-content');
    const storedData = getFromStorage(STORAGE_KEY);

    if (!storedData) {
      window.location.href = '/contact';
      return;
    }

    const data = JSON.parse(storedData);
    const inquiryLabel = INQUIRY_TYPE_LABELS[data.inquiryType] || '未選択';

    contentEl.innerHTML = `
      <nav aria-label="お問い合わせ進捗" class="w-full max-w-progress">
        <ol class="progressbar">
          <li class="item active"><span class="font-medium">ご入力</span></li>
          <li class="item active"><span class="font-medium">ご確認</span></li>
          <li class="item"><span class="font-medium">完了</span></li>
        </ol>
      </nav>
      <div class="w-full flex flex-col gap-6">
        <div class="form-field space-y-1">
          <p class="block text-sm font-medium text-text">氏名<span class="text-red-500 ml-1">*</span></p>
          <p class="text-text text-base">${escapeHtml(data.name)}</p>
        </div>
        <div class="form-field space-y-1">
          <p class="block text-sm font-medium text-text">メールアドレス<span class="text-red-500 ml-1">*</span></p>
          <p class="text-text text-base">${escapeHtml(data.email)}</p>
        </div>
        <div class="form-field space-y-1">
          <p class="block text-sm font-medium text-text">お問い合わせ種別</p>
          <p class="text-text text-base">${escapeHtml(inquiryLabel)}</p>
        </div>
        <div class="form-field space-y-1">
          <p class="block text-sm font-medium text-text">お電話番号</p>
          <p class="text-text text-base">${escapeHtml(data.phone || '未入力')}</p>
        </div>
        <div class="form-field space-y-1">
          <p class="block text-sm font-medium text-text">お問い合わせ内容<span class="text-red-500 ml-1">*</span></p>
          <p class="text-text text-base whitespace-pre-wrap">${escapeHtml(data.message)}</p>
        </div>
        <div id="confirm-message" class="hidden px-4 py-3 rounded-lg text-center" aria-live="polite"></div>
      </div>
    `;

    // 固定ボタンエリアを作成
    const fixedButtonArea = document.createElement('div');
    fixedButtonArea.id = 'fixed-button-area';
    fixedButtonArea.className = 'fixed bottom-0 left-0 right-0 bg-bg-section px-4 py-4 z-10';
    fixedButtonArea.innerHTML = `
      <div class="max-w-form mx-auto flex flex-row gap-4 justify-center">
        <button type="button" id="back-button" class="flex-1 max-w-200px px-4 py-4 rounded-lg font-semibold text-base cursor-pointer transition-colors bg-gray-200 text-text border-none hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed">修正する</button>
        <button type="button" id="submit-button" class="flex-1 max-w-200px px-4 py-4 rounded-lg font-semibold text-base cursor-pointer transition-colors bg-gold text-white border-none hover:bg-gold-dark disabled:opacity-50 disabled:cursor-not-allowed">送信する</button>
      </div>
    `;
    document.body.appendChild(fixedButtonArea);

    // コンテンツ下部に固定ボタン分の余白を追加
    const section = document.querySelector('section');
    section.style.paddingBottom = '100px';

    document.getElementById('back-button').addEventListener('click', () => {
      window.location.href = '/contact';
    });

    document.getElementById('submit-button').addEventListener('click', async () => {
      const submitButton = document.getElementById('submit-button');
      const backButton = document.getElementById('back-button');
      const messageEl = document.getElementById('confirm-message');

      submitButton.disabled = true;
      submitButton.textContent = '送信中...';
      backButton.disabled = true;
      messageEl.textContent = '';
      messageEl.classList.add('hidden');
      messageEl.classList.remove('bg-red-100', 'text-red-800', 'bg-yellow-100', 'text-yellow-800');

      const result = await submitWithRetry(storedData, (progressMessage) => {
        submitButton.textContent = progressMessage;
        messageEl.textContent = 'ネットワークエラーが発生したため、自動的に再試行しています...';
        messageEl.classList.remove('hidden', 'bg-red-100', 'text-red-800');
        messageEl.classList.add('bg-yellow-100', 'text-yellow-800');
      });

      if (result.success) {
        removeFromStorage(STORAGE_KEY);
        window.location.href = '/contact/thanks';
      } else {
        messageEl.textContent = result.message;
        messageEl.classList.remove('hidden', 'bg-yellow-100', 'text-yellow-800');
        messageEl.classList.add('bg-red-100', 'text-red-800');
        submitButton.disabled = false;
        submitButton.textContent = '送信する';
        backButton.disabled = false;
      }
    });
  }

  init();
</script>
