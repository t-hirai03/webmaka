---
import SectionTitle from '@/components/ui/SectionTitle.astro';
import Layout from '@/layouts/Layout.astro';

const INQUIRY_TYPE_LABELS: Record<string, string> = {
	website: 'Webサイト制作',
	lp: 'LP制作',
	cms: 'CMS導入・移行',
	coding: 'コーディング代行',
	other: 'その他',
};
---

<Layout title="入力内容の確認 | うぇぶまか" noindex>
  <section class="pt-12 pb-16 md:pt-28 md:pb-32 bg-bg-section min-h-page">
    <div class="max-w-container mx-auto px-4">
      <SectionTitle title="Confirm" subtitle="入力内容の確認" />

      <div id="confirm-content" class="max-w-xl mx-auto">
        <p class="text-center text-text-muted">読み込み中...</p>
      </div>
    </div>
  </section>
</Layout>

<script is:inline define:vars={{ INQUIRY_TYPE_LABELS }}>
  const STORAGE_KEY = 'contactFormData';

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function init() {
    const contentEl = document.getElementById('confirm-content');
    const storedData = sessionStorage.getItem(STORAGE_KEY);

    if (!storedData) {
      window.location.href = '/contact';
      return;
    }

    const data = JSON.parse(storedData);
    const inquiryLabel = INQUIRY_TYPE_LABELS[data.inquiryType] || '未選択';

    contentEl.innerHTML = `
      <dl class="flex flex-col bg-white p-0 rounded-xl overflow-hidden shadow-sm">
        <div class="flex flex-col gap-3 px-5 py-5 sm:px-8 sm:py-6 border-b border-gray-200">
          <dt class="font-bold text-sm text-text-muted uppercase tracking-wide">氏名</dt>
          <dd class="text-text text-lg leading-normal-plus">${escapeHtml(data.name)}</dd>
        </div>
        <div class="flex flex-col gap-3 px-5 py-5 sm:px-8 sm:py-6 border-b border-gray-200">
          <dt class="font-bold text-sm text-text-muted uppercase tracking-wide">メールアドレス</dt>
          <dd class="text-text text-lg leading-normal-plus">${escapeHtml(data.email)}</dd>
        </div>
        <div class="flex flex-col gap-3 px-5 py-5 sm:px-8 sm:py-6 border-b border-gray-200">
          <dt class="font-bold text-sm text-text-muted uppercase tracking-wide">お問い合わせ種別</dt>
          <dd class="text-text text-lg leading-normal-plus">${escapeHtml(inquiryLabel)}</dd>
        </div>
        <div class="flex flex-col gap-3 px-5 py-5 sm:px-8 sm:py-6 border-b border-gray-200">
          <dt class="font-bold text-sm text-text-muted uppercase tracking-wide">お電話番号</dt>
          <dd class="text-text text-lg leading-normal-plus">${escapeHtml(data.phone || '未入力')}</dd>
        </div>
        <div class="flex flex-col gap-3 px-5 py-5 sm:px-8 sm:py-6">
          <dt class="font-bold text-sm text-text-muted uppercase tracking-wide">お問い合わせ内容</dt>
          <dd class="text-text text-base leading-normal-plus whitespace-pre-wrap">${escapeHtml(data.message)}</dd>
        </div>
      </dl>
      <div id="confirm-message" class="hidden px-4 py-3 rounded-lg text-center mt-6" aria-live="polite"></div>
      <div class="flex flex-col sm:flex-row gap-4 mt-8 items-center sm:justify-center">
        <button type="button" id="back-button" class="px-8 py-4 rounded-lg font-semibold text-base cursor-pointer transition-colors bg-gray-200 text-text border-none hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed">戻って修正する</button>
        <button type="button" id="submit-button" class="px-8 py-4 rounded-lg font-semibold text-base cursor-pointer transition-colors bg-accent text-white border-none hover:bg-accent-dark disabled:opacity-50 disabled:cursor-not-allowed">送信する</button>
      </div>
    `;

    document.getElementById('back-button').addEventListener('click', () => {
      window.location.href = '/contact';
    });

    document.getElementById('submit-button').addEventListener('click', async () => {
      const submitButton = document.getElementById('submit-button');
      const backButton = document.getElementById('back-button');
      const messageEl = document.getElementById('confirm-message');

      submitButton.disabled = true;
      submitButton.textContent = '送信中...';
      backButton.disabled = true;
      messageEl.textContent = '';
      messageEl.classList.add('hidden');
      messageEl.classList.remove('bg-red-100', 'text-red-800');

      try {
        const response = await fetch('/api/contact', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: storedData,
        });

        const result = await response.json();

        if (result.success) {
          sessionStorage.removeItem(STORAGE_KEY);
          window.location.href = '/contact/thanks';
        } else {
          messageEl.textContent = result.error || '送信に失敗しました。もう一度お試しください。';
          messageEl.classList.remove('hidden');
          messageEl.classList.add('bg-red-100', 'text-red-800');
          submitButton.disabled = false;
          submitButton.textContent = '送信する';
          backButton.disabled = false;
        }
      } catch {
        messageEl.textContent = '通信エラーが発生しました。もう一度お試しください。';
        messageEl.classList.remove('hidden');
        messageEl.classList.add('bg-red-100', 'text-red-800');
        submitButton.disabled = false;
        submitButton.textContent = '送信する';
        backButton.disabled = false;
      }
    });
  }

  init();
</script>
