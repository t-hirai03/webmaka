---
import beyerdynamicImg from '@/assets/works/beyerdynamic.png';
import jgiImg from '@/assets/works/jgi.png';
import kanekiImg from '@/assets/works/kaneki.png';
import obataImg from '@/assets/works/obata.png';
import takazenImg from '@/assets/works/takazen.png';
import SectionTitle from '@/components/ui/SectionTitle.astro';
import WorkCard from '@/components/ui/WorkCard.astro';

interface WorkItem {
	id: string;
	title: string;
	category: string;
	description: string;
	url: string;
	image: ImageMetadata;
}

const works: WorkItem[] = [
	{
		id: 'beyerdynamic',
		title: 'beyerdynamic',
		category: 'コーポレートサイト',
		description:
			'ドイツの高品質オーディオ機器ブランドの日本向けサイト。製品の魅力を伝えるビジュアル重視のデザイン。',
		url: 'https://beyerdynamic.co.jp/',
		image: beyerdynamicImg,
	},
	{
		id: 'jgi',
		title: '地球科学総合研究所',
		category: 'コーポレートサイト',
		description:
			'物理探査・地震探査を行う企業のコーポレートサイト。多数のページと情報を整理した大規模サイト。',
		url: 'https://jgi-inc.com/',
		image: jgiImg,
	},
	{
		id: 'obata',
		title: '小畑製紙所',
		category: 'コーポレートサイト',
		description:
			'越前和紙の透かし入れ卒業証書を製造する老舗のランディングページ。伝統と技術を訴求。',
		url: 'https://obataseishijo.jp/lp/',
		image: obataImg,
	},
	{
		id: 'takazen',
		title: '高善産業',
		category: 'コーポレートサイト',
		description:
			'オーダーメイド家具を製造する企業のサイト。職人の技術と製品の魅力を伝えるデザイン。',
		url: 'https://takazen-sangyo.com/',
		image: takazenImg,
	},
	{
		id: 'kaneki',
		title: 'カネキ運輸',
		category: 'コーポレートサイト',
		description: '運送事業・倉庫業を営む企業のコーポレートサイト。シンプルで見やすい構成。',
		url: 'https://kaneki-unyu.co.jp/',
		image: kanekiImg,
	},
];
---

<section id="works" aria-label="制作実績" class="bg-bg-section px-16px py-45px md:px-40px md:py-112px">
  <div class="mx-auto flex max-w-section flex-col items-center gap-32px md:gap-64px">
    <SectionTitle title="Works" subtitle="制作実績" />
    <div
      class="flex w-full gap-16px overflow-x-auto snap-x snap-mandatory scroll-px-4 pb-4 scrollbar-none md:grid md:grid-cols-2 md:gap-20px md:overflow-x-visible md:snap-none md:pb-0 xl:grid-cols-3 focus:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2"
      id="works-slider"
      tabindex="0"
      role="region"
      aria-roledescription="カルーセル"
    >
      {works.map((work) => (
        <WorkCard
          title={work.title}
          category={work.category}
          description={work.description}
          url={work.url}
          image={work.image}
        />
      ))}
    </div>
    <div class="flex justify-center gap-2 mt-4 md:hidden" id="works-pagination">
      {works.map((_, index) => (
        <button
          class={`works-dot w-2 h-2 rounded-full border-none p-0 cursor-pointer transition-all duration-200 ${index === 0 ? 'is-active opacity-100 bg-primary scale-125' : 'opacity-30 bg-text-muted'}`}
          data-index={index}
          aria-label={`スライド ${index + 1} へ移動`}
        />
      ))}
    </div>
  </div>
</section>

<script>
  function initWorksSlider() {
    const slider = document.getElementById('works-slider');
    const pagination = document.getElementById('works-pagination');
    const dots = pagination?.querySelectorAll<HTMLButtonElement>('.works-dot');
    const cards = slider?.querySelectorAll('.work-card');

    if (!slider || !dots || !cards) return;

    let currentIndex = 0;

    const updateActiveDot = () => {
      const sliderRect = slider.getBoundingClientRect();
      const sliderCenter = sliderRect.left + sliderRect.width / 2;

      let closestIndex = 0;
      let closestDistance = Infinity;

      cards.forEach((card, index) => {
        const cardRect = card.getBoundingClientRect();
        const cardCenter = cardRect.left + cardRect.width / 2;
        const distance = Math.abs(sliderCenter - cardCenter);

        if (distance < closestDistance) {
          closestDistance = distance;
          closestIndex = index;
        }
      });

      currentIndex = closestIndex;

      dots.forEach((dot, index) => {
        const isActive = index === closestIndex;
        dot.classList.toggle('is-active', isActive);
        dot.classList.toggle('opacity-100', isActive);
        dot.classList.toggle('bg-primary', isActive);
        dot.classList.toggle('scale-125', isActive);
        dot.classList.toggle('opacity-30', !isActive);
        dot.classList.toggle('bg-text-muted', !isActive);
      });
    };

    const scrollToCard = (index: number) => {
      const targetCard = cards[index];
      if (targetCard) {
        targetCard.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
      }
    };

    // キーボード操作対応
    slider.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
        e.preventDefault();
        const nextIndex = Math.min(currentIndex + 1, cards.length - 1);
        scrollToCard(nextIndex);
      } else if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
        e.preventDefault();
        const prevIndex = Math.max(currentIndex - 1, 0);
        scrollToCard(prevIndex);
      } else if (e.key === 'Home') {
        e.preventDefault();
        scrollToCard(0);
      } else if (e.key === 'End') {
        e.preventDefault();
        scrollToCard(cards.length - 1);
      }
    });

    slider.addEventListener('scroll', updateActiveDot, { passive: true });

    dots.forEach((dot) => {
      dot.addEventListener('click', () => {
        const index = Number(dot.dataset.index);
        scrollToCard(index);
      });
    });
  }

  // 初回ロード時とView Transitionsでのページ遷移後に初期化
  initWorksSlider();
  document.addEventListener('astro:page-load', initWorksSlider);
</script>

