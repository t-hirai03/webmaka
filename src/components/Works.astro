---
import { ExternalLink } from 'lucide-astro';
import Heading from './ui/Heading.astro';
import SectionTitle from './ui/SectionTitle.astro';

interface WorkItem {
	id: string;
	title: string;
	category: string;
	description: string;
	url: string;
	image: string;
}

const works: WorkItem[] = [
	{
		id: 'beyerdynamic',
		title: 'beyerdynamic',
		category: 'ブランドサイト',
		description:
			'ドイツの高品質オーディオ機器ブランドの日本向けサイト。製品の魅力を伝えるビジュアル重視のデザイン。',
		url: 'https://beyerdynamic.co.jp/',
		image: '/works/beyerdynamic.png',
	},
	{
		id: 'jgi',
		title: '地球科学総合研究所',
		category: 'コーポレートサイト',
		description:
			'物理探査・地震探査を行う企業のコーポレートサイト。多数のページと情報を整理した大規模サイト。',
		url: 'https://jgi-inc.com/',
		image: '/works/jgi.png',
	},
	{
		id: 'obata',
		title: '小畑製紙所',
		category: 'LP',
		description:
			'越前和紙の透かし入れ卒業証書を製造する老舗のランディングページ。伝統と技術を訴求。',
		url: 'https://obataseishijo.jp/lp/',
		image: '/works/obata.png',
	},
	{
		id: 'takazen',
		title: '高善産業',
		category: 'コーポレートサイト',
		description:
			'オーダーメイド家具を製造する企業のサイト。職人の技術と製品の魅力を伝えるデザイン。',
		url: 'https://takazen-sangyo.com/',
		image: '/works/takazen.png',
	},
	{
		id: 'kaneki',
		title: 'カネキ運輸',
		category: 'コーポレートサイト',
		description: '運送事業・倉庫業を営む企業のコーポレートサイト。シンプルで見やすい構成。',
		url: 'https://kaneki-unyu.co.jp/',
		image: '/works/kaneki.png',
	},
];
---

<section id="works" class="pt-12 pb-16 md:pt-28 md:pb-32 bg-bg-section">
  <div class="max-w-[var(--container-max)] mx-auto px-4">
    <SectionTitle title="Works" subtitle="制作実績" />
    <div class="flex gap-4 overflow-x-auto snap-x snap-mandatory scroll-px-4 pb-4 -mx-4 px-4 [scrollbar-width:none] [-webkit-overflow-scrolling:touch] [&::-webkit-scrollbar]:hidden md:grid md:grid-cols-2 md:gap-8 md:overflow-x-visible md:snap-none md:mx-0 md:px-0 md:pb-0 xl:grid-cols-3" id="works-slider">
      {works.map((work) => (
        <article class="work-card shrink-0 basis-[85%] snap-center bg-white rounded-2xl overflow-hidden shadow-sm md:shrink md:basis-auto">
          <a href={work.url} target="_blank" rel="noopener noreferrer" class="block no-underline text-inherit h-full group">
            <div class="aspect-[16/10] overflow-hidden">
              <img src={work.image} alt={work.title} loading="lazy" class="w-full h-full object-cover object-top" />
            </div>
            <div class="p-6">
              <div class="flex justify-between items-center mb-4">
                <span class="inline-block text-xs font-semibold text-primary bg-primary/10 px-3 py-1 rounded-full">{work.category}</span>
                <ExternalLink class="text-text-muted transition-colors duration-200 group-hover:text-primary" size={16} />
              </div>
              <Heading level={3} variant="card" class="mb-3 leading-snug">{work.title}</Heading>
              <p class="text-sm text-text-muted leading-relaxed">{work.description}</p>
            </div>
          </a>
        </article>
      ))}
    </div>
    <div class="flex justify-center gap-2 mt-4 md:hidden" id="works-pagination">
      {works.map((_, index) => (
        <button
          class={`works-dot w-2 h-2 rounded-full border-none p-0 cursor-pointer transition-all duration-200 ${index === 0 ? 'is-active opacity-100 bg-primary scale-125' : 'opacity-30 bg-text-muted'}`}
          data-index={index}
          aria-label={`スライド ${index + 1} へ移動`}
        />
      ))}
    </div>
  </div>
</section>

<script>
  const slider = document.getElementById('works-slider');
  const pagination = document.getElementById('works-pagination');
  const dots = pagination?.querySelectorAll<HTMLButtonElement>('.works-dot');
  const cards = slider?.querySelectorAll('.work-card');

  if (slider && dots && cards) {
    const updateActiveDot = () => {
      const sliderRect = slider.getBoundingClientRect();
      const sliderCenter = sliderRect.left + sliderRect.width / 2;

      let closestIndex = 0;
      let closestDistance = Infinity;

      cards.forEach((card, index) => {
        const cardRect = card.getBoundingClientRect();
        const cardCenter = cardRect.left + cardRect.width / 2;
        const distance = Math.abs(sliderCenter - cardCenter);

        if (distance < closestDistance) {
          closestDistance = distance;
          closestIndex = index;
        }
      });

      dots.forEach((dot, index) => {
        const isActive = index === closestIndex;
        dot.classList.toggle('is-active', isActive);
        dot.classList.toggle('opacity-100', isActive);
        dot.classList.toggle('bg-primary', isActive);
        dot.classList.toggle('scale-125', isActive);
        dot.classList.toggle('opacity-30', !isActive);
        dot.classList.toggle('bg-text-muted', !isActive);
      });
    };

    slider.addEventListener('scroll', updateActiveDot, { passive: true });

    dots.forEach((dot) => {
      dot.addEventListener('click', () => {
        const index = Number(dot.dataset.index);
        const targetCard = cards[index];
        if (targetCard) {
          targetCard.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
        }
      });
    });
  }
</script>

