---
import Button from './ui/Button.astro';
import FormField from './ui/FormField.astro';
import Input from './ui/Input.astro';
import SectionTitle from './ui/SectionTitle.astro';
import Select from './ui/Select.astro';
import Textarea from './ui/Textarea.astro';
---

<section id="contact" aria-label="お問い合わせ" class="pt-12 pb-16 md:pt-28 md:pb-32 bg-bg-section">
  <div class="max-w-container mx-auto px-4">
    <SectionTitle title="Contact" subtitle="お問い合わせ" />
    <form id="contact-form" class="max-w-xl mx-auto flex flex-col gap-6">
      <FormField label="氏名" name="name" required>
        <Input type="text" name="name" id="name" required class="border-none" />
      </FormField>
      <FormField label="メールアドレス" name="email" required>
        <Input type="email" name="email" id="email" required class="border-none" />
      </FormField>
      <FormField label="お問い合わせ種別" name="inquiry-type">
        <Select name="inquiry-type" id="inquiry-type" class="border-none">
          <option value="">選択してください</option>
          <option value="website">Webサイト制作</option>
          <option value="lp">LP制作</option>
          <option value="cms">CMS導入・移行</option>
          <option value="coding">コーディング代行</option>
          <option value="other">その他</option>
        </Select>
      </FormField>
      <FormField label="お電話番号" name="phone">
        <Input type="tel" name="phone" id="phone" class="border-none" />
      </FormField>
      <FormField label="お問い合わせ内容" name="message" required>
        <Textarea name="message" id="message" rows={5} required class="border-none" />
      </FormField>
      <div id="contact-message" class="contact-message hidden px-4 py-3 rounded-lg text-center" aria-live="polite"></div>
      <div class="text-center">
        <Button type="submit" variant="secondary" size="lg">
          確認する
        </Button>
      </div>
    </form>
  </div>
</section>

<script>
  const STORAGE_KEY = 'contactFormData';
  const form = document.getElementById('contact-form') as HTMLFormElement;
  const messageEl = document.getElementById('contact-message') as HTMLDivElement;

  // 確認画面から戻った場合、入力内容を復元
  function restoreFormData() {
    const storedData = sessionStorage.getItem(STORAGE_KEY);
    if (!storedData) return;

    const data = JSON.parse(storedData);
    const nameInput = form.querySelector('#name') as HTMLInputElement;
    const emailInput = form.querySelector('#email') as HTMLInputElement;
    const inquiryTypeSelect = form.querySelector('#inquiry-type') as HTMLSelectElement;
    const phoneInput = form.querySelector('#phone') as HTMLInputElement;
    const messageTextarea = form.querySelector('#message') as HTMLTextAreaElement;

    if (nameInput) nameInput.value = data.name || '';
    if (emailInput) emailInput.value = data.email || '';
    if (inquiryTypeSelect) inquiryTypeSelect.value = data.inquiryType || '';
    if (phoneInput) phoneInput.value = data.phone || '';
    if (messageTextarea) messageTextarea.value = data.message || '';
  }

  restoreFormData();

  function showError(text: string) {
    messageEl.textContent = text;
    messageEl.classList.remove('hidden', 'bg-green-100', 'text-green-800');
    messageEl.classList.add('bg-red-100', 'text-red-800');
  }

  form.addEventListener('submit', (event) => {
    event.preventDefault();

    const formData = new FormData(form);
    const data = {
      name: formData.get('name') as string,
      email: formData.get('email') as string,
      inquiryType: formData.get('inquiry-type') as string,
      phone: formData.get('phone') as string,
      message: formData.get('message') as string,
    };

    // バリデーション
    if (!data.name.trim()) {
      showError('氏名を入力してください。');
      return;
    }
    if (!data.email.includes('@')) {
      showError('正しいメールアドレスを入力してください。');
      return;
    }
    if (!data.message.trim()) {
      showError('お問い合わせ内容を入力してください。');
      return;
    }

    // sessionStorageに保存して確認画面へ遷移
    sessionStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    window.location.href = '/contact/confirm';
  });
</script>
