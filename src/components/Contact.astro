---
import Button from './ui/Button.astro';
import SectionTitle from './ui/SectionTitle.astro';
---

<section id="contact" class="contact">
  <div class="contact__container">
    <SectionTitle title="Contact" subtitle="お問い合わせ" />
    <form id="contact-form" class="contact__form">
      <div class="contact__field">
        <label for="name" class="contact__label">
          氏名<span class="contact__required">*</span>
        </label>
        <input
          type="text"
          id="name"
          name="name"
          required
          class="contact__input"
        />
      </div>
      <div class="contact__field">
        <label for="email" class="contact__label">
          メールアドレス<span class="contact__required">*</span>
        </label>
        <input
          type="email"
          id="email"
          name="email"
          required
          class="contact__input"
        />
      </div>
      <div class="contact__field">
        <label for="inquiry-type" class="contact__label">お問い合わせ種別</label>
        <select
          id="inquiry-type"
          name="inquiry-type"
          class="contact__select"
        >
          <option value="">選択してください</option>
          <option value="website">Webサイト制作</option>
          <option value="lp">LP制作</option>
          <option value="cms">CMS導入・移行</option>
          <option value="coding">コーディング代行</option>
          <option value="other">その他</option>
        </select>
      </div>
      <div class="contact__field">
        <label for="phone" class="contact__label">お電話番号</label>
        <input
          type="tel"
          id="phone"
          name="phone"
          class="contact__input"
        />
      </div>
      <div class="contact__field">
        <label for="message" class="contact__label">
          お問い合わせ内容<span class="contact__required">*</span>
        </label>
        <textarea
          id="message"
          name="message"
          rows="5"
          required
          class="contact__textarea"
        ></textarea>
      </div>
      <div id="contact-message" class="contact__message" aria-live="polite"></div>
      <div class="contact__submit">
        <Button type="submit" variant="secondary" size="lg">
          確認する
        </Button>
      </div>
    </form>
  </div>
</section>

<script>
  const STORAGE_KEY = 'contactFormData';
  const form = document.getElementById('contact-form') as HTMLFormElement;
  const messageEl = document.getElementById('contact-message') as HTMLDivElement;

  // 確認画面から戻った場合、入力内容を復元
  function restoreFormData() {
    const storedData = sessionStorage.getItem(STORAGE_KEY);
    if (!storedData) return;

    const data = JSON.parse(storedData);
    const nameInput = form.querySelector('#name') as HTMLInputElement;
    const emailInput = form.querySelector('#email') as HTMLInputElement;
    const inquiryTypeSelect = form.querySelector('#inquiry-type') as HTMLSelectElement;
    const phoneInput = form.querySelector('#phone') as HTMLInputElement;
    const messageTextarea = form.querySelector('#message') as HTMLTextAreaElement;

    if (nameInput) nameInput.value = data.name || '';
    if (emailInput) emailInput.value = data.email || '';
    if (inquiryTypeSelect) inquiryTypeSelect.value = data.inquiryType || '';
    if (phoneInput) phoneInput.value = data.phone || '';
    if (messageTextarea) messageTextarea.value = data.message || '';
  }

  restoreFormData();

  form.addEventListener('submit', (event) => {
    event.preventDefault();

    const formData = new FormData(form);
    const data = {
      name: formData.get('name') as string,
      email: formData.get('email') as string,
      inquiryType: formData.get('inquiry-type') as string,
      phone: formData.get('phone') as string,
      message: formData.get('message') as string,
    };

    // バリデーション
    if (!data.name.trim()) {
      messageEl.textContent = '氏名を入力してください。';
      messageEl.classList.add('contact__message--error');
      return;
    }
    if (!data.email.includes('@')) {
      messageEl.textContent = '正しいメールアドレスを入力してください。';
      messageEl.classList.add('contact__message--error');
      return;
    }
    if (!data.message.trim()) {
      messageEl.textContent = 'お問い合わせ内容を入力してください。';
      messageEl.classList.add('contact__message--error');
      return;
    }

    // sessionStorageに保存して確認画面へ遷移
    sessionStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    window.location.href = '/contact/confirm';
  });
</script>

<style>
  .contact {
    padding-block: 3rem 4rem;
    background-color: var(--color-bg-section);
  }

  @media (min-width: 768px) {
    .contact {
      padding-block: 7rem 8rem;
    }
  }

  .contact__container {
    max-width: var(--container-max);
    margin-inline: auto;
    padding-inline: 1rem;
  }

  .contact__form {
    max-width: 36rem;
    margin-inline: auto;
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .contact__field {
    display: flex;
    flex-direction: column;
  }

  .contact__label {
    color: var(--color-text);
    margin-block-end: 0.5rem;
  }

  .contact__required {
    color: #dc2626;
    margin-inline-start: 0.25rem;
  }

  .contact__input,
  .contact__textarea,
  .contact__select {
    width: 100%;
    background-color: #fff;
    border-radius: 0.5rem;
    padding: 0.75rem;
    color: var(--color-text);
    border: none;
  }

  .contact__select {
    cursor: pointer;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%236B7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 0.75rem center;
    padding-inline-end: 2.5rem;
  }

  .contact__input:focus,
  .contact__textarea:focus,
  .contact__select:focus {
    outline: none;
    box-shadow: 0 0 0 2px var(--color-accent);
  }

  .contact__textarea {
    resize: none;
  }

  .contact__submit {
    text-align: center;
  }

  .contact__message {
    padding: 0.75rem 1rem;
    border-radius: 0.5rem;
    text-align: center;
  }

  .contact__message:empty {
    display: none;
  }

  .contact__message--success {
    background-color: #d1fae5;
    color: #065f46;
  }

  .contact__message--error {
    background-color: #fee2e2;
    color: #991b1b;
  }
</style>
