---
import Button from './ui/Button.astro';
import ContactProgress from './ui/ContactProgress.astro';
import FormField from './ui/FormField.astro';
import Input from './ui/Input.astro';
import SectionTitle from './ui/SectionTitle.astro';
import Select from './ui/Select.astro';
import Textarea from './ui/Textarea.astro';

interface Props {
	compact?: boolean;
}

const { compact = false } = Astro.props;
---

<section id="contact" aria-label="お問い合わせ" class:list={["pt-[calc(48px+var(--height-header-mobile))] pb-16 sm:pt-12 bg-bg-section", compact ? "md:pt-80px md:pb-32" : "md:pt-130px md:pb-32"]}
  <div class="max-w-container mx-auto px-4 flex flex-col items-center gap-10">
    <SectionTitle title="Contact" subtitle="お問い合わせ" />
    <form id="contact-form" class="max-w-form w-full flex flex-col items-center gap-8">
      <ContactProgress currentStep={1} />
      <div class="w-full flex flex-col gap-6">
      <FormField label="氏名" name="name" required>
        <Input type="text" name="name" id="name" required class="border-none" aria-describedby="name-error" />
        <span id="name-error" class="text-sm text-red-600 hidden" role="alert"></span>
      </FormField>
      <FormField label="メールアドレス" name="email" required>
        <Input type="email" name="email" id="email" required class="border-none" aria-describedby="email-error" />
        <span id="email-error" class="text-sm text-red-600 hidden" role="alert"></span>
      </FormField>
      <FormField label="お問い合わせ種別" name="inquiry-type">
        <Select name="inquiry-type" id="inquiry-type" class="border-none">
          <option value="">選択してください</option>
          <option value="website">Webサイト制作</option>
          <option value="lp">LP制作</option>
          <option value="cms">CMS導入・移行</option>
          <option value="coding">コーディング代行</option>
          <option value="other">その他</option>
        </Select>
      </FormField>
      <FormField label="お電話番号" name="phone">
        <Input type="tel" name="phone" id="phone" class="border-none" />
      </FormField>
      <FormField label="お問い合わせ内容" name="message" required>
        <Textarea name="message" id="message" rows={5} required class="border-none" aria-describedby="message-error" />
        <span id="message-error" class="text-sm text-red-600 hidden" role="alert"></span>
      </FormField>
      <div id="contact-message" class="contact-message hidden px-4 py-3 rounded-lg text-center" aria-live="polite"></div>
      <div class="text-center">
        <Button type="submit" variant="gold" size="md">
          確認する
        </Button>
      </div>
      </div>
    </form>
  </div>
</section>

<script>
  const STORAGE_KEY = 'contactFormData';
  const form = document.getElementById('contact-form') as HTMLFormElement;
  const messageEl = document.getElementById('contact-message') as HTMLDivElement;

  // ストレージユーティリティ（sessionStorage優先、フォールバックでlocalStorage）
  function saveToStorage(key: string, value: string) {
    try {
      sessionStorage.setItem(key, value);
    } catch {
      // sessionStorageが使えない場合は無視
    }
    try {
      localStorage.setItem(key, value);
    } catch {
      // localStorageが使えない場合も無視
    }
  }

  function getFromStorage(key: string): string | null {
    try {
      const sessionData = sessionStorage.getItem(key);
      if (sessionData) return sessionData;
    } catch {
      // sessionStorageが使えない場合は無視
    }
    try {
      return localStorage.getItem(key);
    } catch {
      return null;
    }
  }

  // 確認画面から戻った場合、入力内容を復元
  function restoreFormData() {
    const storedData = getFromStorage(STORAGE_KEY);
    if (!storedData) return;

    const data = JSON.parse(storedData);
    const nameInput = form.querySelector('#name') as HTMLInputElement;
    const emailInput = form.querySelector('#email') as HTMLInputElement;
    const inquiryTypeSelect = form.querySelector('#inquiry-type') as HTMLSelectElement;
    const phoneInput = form.querySelector('#phone') as HTMLInputElement;
    const messageTextarea = form.querySelector('#message') as HTMLTextAreaElement;

    if (nameInput) nameInput.value = data.name || '';
    if (emailInput) emailInput.value = data.email || '';
    if (inquiryTypeSelect) inquiryTypeSelect.value = data.inquiryType || '';
    if (phoneInput) phoneInput.value = data.phone || '';
    if (messageTextarea) messageTextarea.value = data.message || '';
  }

  restoreFormData();

  const nameInput = form.querySelector('#name') as HTMLInputElement;
  const emailInput = form.querySelector('#email') as HTMLInputElement;
  const messageTextarea = form.querySelector('#message') as HTMLTextAreaElement;
  const nameError = document.getElementById('name-error') as HTMLSpanElement;
  const emailError = document.getElementById('email-error') as HTMLSpanElement;
  const messageError = document.getElementById('message-error') as HTMLSpanElement;

  // メールアドレスの正規表現（RFC 5322準拠の簡易版）
  const EMAIL_REGEX = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

  function clearFieldError(input: HTMLInputElement | HTMLTextAreaElement, errorEl: HTMLSpanElement) {
    input.setAttribute('aria-invalid', 'false');
    errorEl.textContent = '';
    errorEl.classList.add('hidden');
  }

  function setFieldError(input: HTMLInputElement | HTMLTextAreaElement, errorEl: HTMLSpanElement, message: string) {
    input.setAttribute('aria-invalid', 'true');
    errorEl.textContent = message;
    errorEl.classList.remove('hidden');
    input.focus();
  }

  function clearAllErrors() {
    clearFieldError(nameInput, nameError);
    clearFieldError(emailInput, emailError);
    clearFieldError(messageTextarea, messageError);
    messageEl.classList.add('hidden');
  }

  form.addEventListener('submit', (event) => {
    event.preventDefault();
    clearAllErrors();

    const formData = new FormData(form);
    const data = {
      name: formData.get('name') as string,
      email: formData.get('email') as string,
      inquiryType: formData.get('inquiry-type') as string,
      phone: formData.get('phone') as string,
      message: formData.get('message') as string,
      sourceUrl: window.location.href,
    };

    // バリデーション
    if (!data.name.trim()) {
      setFieldError(nameInput, nameError, '氏名を入力してください。');
      return;
    }
    if (!EMAIL_REGEX.test(data.email)) {
      setFieldError(emailInput, emailError, '正しいメールアドレスを入力してください。');
      return;
    }
    if (!data.message.trim()) {
      setFieldError(messageTextarea, messageError, 'お問い合わせ内容を入力してください。');
      return;
    }

    // ストレージに保存して確認画面へ遷移
    saveToStorage(STORAGE_KEY, JSON.stringify(data));
    window.location.href = '/contact/confirm';
  });
</script>
